<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- 1) Acción de servidor: primero -->
        <record id="ir_actions_server_sid_bonds_pdf_uploaded" model="ir.actions.server">
            <field name="name">Avales - Disparar al crear con PDF</field>
            <field name="model_id" ref="model_sid_bonds_orders"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
for record in records:
    if record.pdf_aval:
        document_name = f"{record.order_ids.name} {getattr(record, 'x_origen', '')}"
        document_vals = {
            'name': record.reference,
            'datas': record.pdf_aval,
            'res_model': 'sid_bonds_orders',  # o el _name real de tu modelo
            'res_id': record.id,
            'folder_id': env.ref('sid_bonds_orders.folder_avales').id,
            'document_description': document_name
        }

        existing_document = env['documents.document'].search([
            ('res_model', '=', 'sid_bonds_orders'),
            ('res_id', '=', record.id),
            ('folder_id', '=', env.ref('sid_bonds_orders.folder_avales').id)
        ], limit=1)

        if existing_document:
            existing_document.write(document_vals)
        else:
            env['documents.document'].create(document_vals)
            ]]></field>
        </record>

        <!-- 2) Automatización: después -->
        <record id="base_automation_sid_bonds_on_pdf_create" model="base.automation">
            <field name="name">Avales - Disparar al crear con PDF</field>
            <field name="model_id" ref="model_sid_bonds_orders"/>
            <field name="trigger">on_create</field>
            <field name="filter_domain">[('pdf_aval', '!=', False)]</field>
            <field name="action_server_id" ref="ir_actions_server_sid_bonds_pdf_uploaded"/>
            <field name="active">True</field>
        </record>

    </data>
</odoo>
